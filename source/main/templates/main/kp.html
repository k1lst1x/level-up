{# main/templates/main/kp.html #}
{% extends "base.html" %}
{% block title %}КП{% endblock %}

{% block content %}
  <div class="card">
    <div class="muted" style="font-size:13px;">КП → Черновик</div>

    {% if kp %}
      <h2 style="margin:6px 0;">{{ kp.title }}</h2>

      <div class="muted">
        Итого:
        <b>
          {% if total_sum %}{{ total_sum }}{% else %}0{% endif %}
        </b> ₸
      </div>

      {# ✅ очистка работает только если kp существует #}
      <form method="post" action="{% url 'kp:clear' kp.id %}" style="margin-top:10px;">
        {% csrf_token %}
        <button class="btn btn-danger" type="submit">Очистить КП</button>
      </form>

      {# ✅ клиент может "создать КП" = отправить заявку менеджеру #}
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <a class="btn" href="{% url 'main:home' %}">Перейти в категории</a>

        {% if items and items|length > 0 %}
          <form method="post" action="{% url 'kp:customer_request_submit' %}" style="margin:0;">
            {% csrf_token %}
            <button class="btn btn-primary" type="submit">Создать КП</button>
          </form>
        {% else %}
          <div class="muted" style="font-size:12px;">
            Чтобы создать КП, сначала добавь услуги.
          </div>
        {% endif %}
      </div>

      <div class="muted" style="margin-top:10px; font-size:12px;">
        Ты собираешь услуги, а менеджер подтверждает и связывается с тобой.
      </div>

      {% if messages %}
        <div style="margin-top:10px;">
          {% for message in messages %}
            <div class="muted" style="font-size:12px;">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

    {% else %}
      <h2 style="margin:6px 0;">Черновик КП</h2>
      <div class="muted">Черновик ещё не создан.</div>

      <div style="margin-top:12px;">
        <a class="btn" href="{% url 'main:home' %}">Перейти в категории</a>
      </div>
    {% endif %}
  </div>

  <div style="margin-top:12px;">
    {% for it in items %}
      <div class="card" style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
        <div style="width:72px; height:54px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#eef0f6;">
          {% if it.service.image %}
            <img src="{{ it.service.image.url }}" alt="{{ it.service.name }}"
                 style="width:100%; height:100%; object-fit:cover;">
          {% endif %}
        </div>

        <div style="flex:1; min-width:0;">
          <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            {{ it.service.name }}
          </div>
          <div class="muted" style="font-size:12px;">
            {{ it.qty }} шт · {{ it.price }} ₸
            {% if it.discount and it.discount > 0 %} · скидка {{ it.discount }}{% endif %}
          </div>
        </div>

        <div style="text-align:right;">
          <div style="font-weight:900;">{{ it.total_price }} ₸</div>
          <form method="post" action="{% url 'kp:remove_item' it.id %}" style="margin-top:6px;">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit">Убрать</button>
          </form>
        </div>
      </div>
    {% empty %}
      <div class="card">
        <div class="muted">Пока пусто. Иди в подкатегорию и нажми “Выбрать”.</div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
